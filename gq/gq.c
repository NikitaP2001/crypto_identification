#include <stdbool.h>
#include <stdlib.h>

#include <gmptools.h>
#include "gq.h"

static const char *domain_p_1024 = "10611883578308384411354608894331199883838299" \
                                   "88786854613844964970351946838349510066771477" \
                                   "70721373342273909479621515299896943660251488" \
                                   "56184090524165357943533";
static const char *domain_q_1024 = "11607089161902499241717501403185857077978903" \
                                   "89627507299476168199561181723925895302434779" \
                                   "79583470530023176383943222773126435444291432" \
                                   "83649655096152260372287";
static const char *domain_n_1024 = "12317307886915436029907316857785085068033671" \
                                   "89280390601605533929913628313151992076710544" \
                                   "92967266944403331521858069650979345399320429" \
                                   "83039397008537625401824415854965875939021691" \
                                   "15171468769070489793834564895996669995095931" \
                                   "36213882497964606727991015594524530630778845" \
                                   "322068122676106398018935220064598947304069971";

static const char *domain_p_2048 = "14989862801978795517059319599636935547689806" \
                                   "09972572115787852127040853112715435929361076" \
                                   "00284278223390447784786305104522126586035565" \
                                   "32678064815253343580866685122157060162548754" \
                                   "31794766171451781856563428231166818636457869" \
                                   "05046763994875015891635517403257259398381426" \
                                   "179410777039626458255107024549028940574768397";
static const char *domain_q_2048 = "16680913846261530735812766215194237528961350" \
                                   "03671842044448222929684674785190375685335458" \
                                   "33978299101372133019877800813225767208818392" \
                                   "48204321135606955004409832494955341155008940" \
                                   "84052067943303161768727360024367629668742917" \
                                   "11301320311310664937426167303324806753341242" \
                                   "214612545879365673520834330847861509779864217";
static const char *domain_n_2048 = "25004460996708875618725146141475935769674672" \
                                   "43951146927922368092184496742691159949907947" \
                                   "63568607404484582644061878843478514232252612" \
                                   "28507216784577488372099743380772816784886089" \
                                   "32100204246780404915489533274666816634717852" \
                                   "14720090511252824824678275275033107884530797" \
                                   "78709335575705907500916903121144135796387687" \
                                   "49665226109097218962911964964069989217582025" \
                                   "04818006914033407268172385267355102553465627" \
                                   "84805918019992260946903376837586697867853175" \
                                   "33497830186293915757553328614758755750216572" \
                                   "27465970432458619091449424437108063956958356" \
                                   "48160683124862163954125325281994550585319603" \
                                   "349906038292147441948191703257612358882750149";

static const char *domain_p_3072 = "17786359615874645437871233144226258894493521" \
                                   "52753302393848985853143003203194444801731986" \
                                   "28310049278281951916103380459701471365618627" \
                                   "89813819857138129559454345089818800841426585" \
                                   "16987321530555872870683520297474557940194205" \
                                   "34185350922085233763657857662129918985204959" \
                                   "25290459545712881358837958778635011278782541" \
                                   "94354202282331475531695229669716663740418728" \
                                   "81736493934651751237349852849343424960898139" \
                                   "95623525818076789423730132368527587802215398" \
                                   "52869699244616568222683";
static const char *domain_q_3072 = "23193557780423970705789433350363874069095702" \
                                   "57045285595707718227663023243947454467980427" \
                                   "43803041790780607062266663038611015424015823" \
                                   "12294838082813614268480939964252691934622911" \
                                   "01714768104391978442596567432258978915762857" \
                                   "09376924800629614811093333752723827648430301" \
                                   "31768913733340768213783857367416555434609191" \
                                   "31112086915094479961132565968351995032204140" \
                                   "69891118976993149586121867008485303298243763" \
                                   "26272871215093835229806996386502703466982101" \
                                   "58070892165519133616771";
static const char *domain_n_3072 = "41252895945418808964004689421071873905396007" \
                                   "80608481268077420518169878542544890080576339" \
                                   "51782757100677289943394643261405442158748333" \
                                   "79006735171658989819467076956565862319838521" \
                                   "20329184822531276865819175556079987808340481" \
                                   "89599472558077020153884782311951061599844096" \
                                   "42270677359423886135371240672778995791091688" \
                                   "78563394885525718705048627558163776457852997" \
                                   "71753459441610006804719840888552871868411910" \
                                   "03529717048116529775581061397581113492143427" \
                                   "52700751015380921656766137136329962735165299" \
                                   "52492243880366172170189523382269394891221284" \
                                   "59485717104050560033387376842497944612548079" \
                                   "44786966698737322854729481183344171615605418" \
                                   "13582900867096552704349783790180998828921028" \
                                   "49559271866982181626270553462118834353354314" \
                                   "55435908148401748639547044482823796393557964" \
                                   "62401231760097444620500523554586127022278101" \
                                   "35475216229060077386971369499212327580687732" \
                                   "27797932642445365354059638316712654073887219" \
                                   "877816242933304171902343005691246493111416593";

static const char *key_x_3072 = "50236724635617162149598168901701078706220698435983033221864901612568661111066024" \
                                "47391410893706414818883467363697785938305536591012866398884410236958787472586337" \
                                "55743938510275689305076653031089037480947628854898032865175896692052186908264769" \
                                "64617664260392991753934022460900102705348454069518600929133791023093505898581396" \
                                "15855368801588550154734438007138367473103993937365398897373170652649627424738919" \
                                "11628310961965042397956146597409043721260348178574060709048915313219207742057326" \
                                "55416523062616151858015668525576445587950012269009085029323932947127128943250125" \
                                "08785786606392354852264404164167253751326929144470176149317473366170208414853129" \
                                "13196195642011930738504869955791235231586030760873098998421549245404491794372930" \
                                "15129071249104967887283280548063976311306808019706351917737591817749378603684312" \
                                "20926133887070192073001673179929935587468261055508062784985139714517968462702352" \
                                "481529990853717488485462178053631240133262187";

static const char *key_y_3072 = "19752692012031770368295805656300572022070182094587533767527803011659516137367069" \
                                "92488213197190228953831300270194909472489387974359187747411030346601838264002863" \
                                "62164411542156688856590771020256004664379243935087843053448864623076852433112016" \
                                "81675622969027719431345338733947708302616049364621411171682621294034233156908334" \
                                "61644195766472121264080538923731720110322862900884584949133478474949044725410934" \
                                "22771265869884289552399442124227411151911614383923021209743827936737958055249352" \
                                "91335677763373323072128020214829748924896603334195756175852421849166321773733607" \
                                "43358871953321575397444294607452439384565376683328483651596989871390042604614796" \
                                "84559930205680293533039789979979803693834884787053079111791512712556070060793884" \
                                "02475232611017452562338780855263677446767987445917862602677200485374640291881223" \
                                "78514616315727988880174280005593805310779457109893546127062049200342884885439313" \
                                "14374260076868277309924153006395700225521920";

static const char *key_x_2048 = "68904472553810641948855494736596223623773837402658485241937584061630656989101269" \
                                "20916742997312238507911554375387699504464845111215445470420827780000514520911035" \
                                "17832056825614478920260236099859383945495155452925125706268832804224085171149652" \
                                "50113319565292950325895012324385049603272290057283431514553984586897862832322611" \
                                "35150115709119375006463840782487035499839181282167693032595999280542424422525978" \
                                "92934390524114625813565386443148362768574619371279766368730473522176017758325235" \
                                "03287054833504283192258586381508643146095971475829029270976709453997121519064824" \
                                "81989788079417082399541933163615037240743580418379973608";

static const char *key_y_2048 = "17367592538716235431446676701768810102718168300441691756431224126311059574907626" \
                                "60871604216993430952188674721255331355876869999305542326253482976872708717512995" \
                                "09923525716458241493861286517568026170458128034968861944401010036092653616609588" \
                                "32166291793730693284338193003268793579675272982129752750517697260152712628300877" \
                                "82886931576950397960871196397325346346691318973229370393907582508887550330964922" \
                                "56333762373690957102008371944503260140682401533238480084231154038108327826869309" \
                                "30850544713084886250082629573305050011560779426076897452991568606671262295242299" \
                                "662695771479261547411386641067938583199032695294433921019";

static const char *key_x_1024 = "13451089185755222979998529519792824109283975794656013335868988920245570241056497" \
                                "04451423630254750740940178838549431592448025378051353934960668779109213314373419" \
                                "95669228325215848663241340421555526359155408160283309625854741335915860446230510" \
                                "422429519157762837926990742428332727870485753117472261584134618442848";

static const char *key_y_1024 = "36534478789639981493257701895714040259717458527578942108897340199985201046609581" \
                                "26896390797801736201347049042861354685999686350093795322762779372345900212593816" \
                                "40234263475735996652660336616618349757791146762387720268512205314921879267362098" \
                                "71630121055420732357015530259858759303822249535588635258630711416953";

_Bool gq_init(struct gq_params *params, size_t bit_size)
{
        if (bit_size != GQ_NLEN_1024 && bit_size != GQ_NLEN_2048 && bit_size != GQ_NLEN_3072)
                return false;

        params->bitsize = bit_size;
        switch (bit_size) {
        case GQ_NLEN_1024:
                mpz_init_set_ui(params->e, GQ_EVALUE);
                mpz_init_set_str(params->p, domain_p_1024, 10);
                mpz_init_set_str(params->q, domain_q_1024, 10);
                mpz_init_set_str(params->n, domain_n_1024, 10);
                return true;
        case GQ_NLEN_2048:
                mpz_init_set_ui(params->e, GQ_EVALUE);
                mpz_init_set_str(params->p, domain_p_2048, 10);
                mpz_init_set_str(params->q, domain_q_2048, 10);
                mpz_init_set_str(params->n, domain_n_2048, 10);
                return true;
        case GQ_NLEN_3072:
                mpz_init_set_ui(params->e, GQ_EVALUE);
                mpz_init_set_str(params->p, domain_p_3072, 10);
                mpz_init_set_str(params->q, domain_q_3072, 10);
                mpz_init_set_str(params->n, domain_n_3072, 10);
                return true; 
        }
        perror("wrong bit length");
        return false;
}

void gq_keys_create(struct gq_params *params, struct member_keys *mparams)
{
        mpz_init(mparams->x);
        mpz_init(mparams->y);
        mpz_init_set(mparams->e, params->e);
        mpz_init_set(mparams->n, params->n);

        gmpt_rndmod(mparams->x, mparams->n);
        mpz_powm(mparams->y, mparams->x, params->e, params->n);
}

void gq_load_keys(struct gq_params *params, struct member_keys *mparams)
{
        switch (params->bitsize) {
        case GQ_NLEN_1024:
                mpz_init_set_str(mparams->x, key_x_1024, 10);
                mpz_init_set_str(mparams->y, key_y_1024, 10);
                mpz_init_set(mparams->e, params->e);
                mpz_init_set(mparams->n, params->n);
                break;
        case GQ_NLEN_2048:
                mpz_init_set_str(mparams->x, key_x_2048, 10);
                mpz_init_set_str(mparams->y, key_y_2048, 10);
                mpz_init_set(mparams->e, params->e);
                mpz_init_set(mparams->n, params->n);
                break;
        case GQ_NLEN_3072:
                mpz_init_set_str(mparams->x, key_x_3072, 10);
                mpz_init_set_str(mparams->y, key_y_3072, 10);
                mpz_init_set(mparams->e, params->e);
                mpz_init_set(mparams->n, params->n);
                break;
        default:
                perror("wrong bitsize");
                break;
        }
}


void gq_commitment(const struct member_keys *params, mpz_t a, mpz_t r)
{
        gmpt_rndmod(r, params->n);
        mpz_powm(a, r, params->e, params->n);
}


void gq_solve(const struct member_keys *params, mpz_t z, const mpz_t r, const mpz_t c)
{
        mpz_powm(z, params->x, c, params->n);
        mpz_mul(z, z, r);
        mpz_mod(z, z, params->n);
}


_Bool gq_verify(const mpz_t z, const mpz_t e, const mpz_t a, mpz_t y, const mpz_t c, const mpz_t n)
{
        _Bool result = false;
        mpz_t z_powe;
        mpz_t ay_powc;
        mpz_init(z_powe);
        mpz_init(ay_powc);

        mpz_powm(z_powe, z, e, n);
        mpz_powm(ay_powc, y, c, n);
        mpz_mul(ay_powc, ay_powc, a);
        mpz_mod(ay_powc, ay_powc, n);
        result = mpz_cmp(ay_powc, z_powe) == 0;

        mpz_clear(z_powe);
        mpz_clear(ay_powc);
        return result;
}


void gq_keys_destroy(struct member_keys *params)
{
        mpz_clear(params->x);
        mpz_clear(params->y);
        mpz_clear(params->e);
        mpz_clear(params->n);
}


void gq_free(struct gq_params *params)
{
        mpz_clear(params->q);
        mpz_clear(params->p);
        mpz_clear(params->n);
        mpz_clear(params->e);
}